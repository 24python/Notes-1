# TCP/IP

+ 复用: 发送方不同的应用进程可以使用同一个运输层协议传送数据

+ 分用: 接收方的运输层在剥去报文的首部后能够把这些数据正确交付目的应用进层

+ 协议端口: 应用层的各种协议进程与运输实体进行层间交互的一种地址.<br/>
TCP/IP的运输层用一个词6位的端口号来标志一个端口.端口号只有本地意义,它只是为了标志本计算机应用层中的各个进程和运输层交互时的层间接口
（协议端口是软件端口， 交换机或路由器上的端口是硬件端口）

+ 运输层的端口号分为两大类:

1. 服务端使用的端口号:

a. 熟知端口号(系统端口号): 数值为0~1023,例如FTP(23) TELNET(23) SMTP(25) DNS(53) TFPT(69) HTTP(80) SSH(22) HTTPS(443)

b. 登记端口号: 1024~49151,没有熟知的应用程序使用,使用需登记.

2. 客户端使用的端口号:

数值为49152~65535,这类端口号仅在客户端进程运行时才动态选择.


## UDP 用户数据报

+ 主要特点:

1. 无连接: 发送数据前不需要建立连接,减少了开销和发送前的时延.

2. 尽最大努力交付: 不保证可靠交付,不用维护连接状态表.

3. 面向报文: 应用层交下来的报文,UDP直接添加首部就直接交付,不拆分也不合并

4. 没有拥塞控制: 网络拥塞不会使源主机降低发送速率.(因为无连接直接发送)

5. UDP支持一对一,多对多,多对一和一对多的交互通信.

6. UDP首部开销小: 只有个字节

+ UDP首部:

  + UDP有两个字段: 首部字段和数据字段.

  + 首部字段:
  只有8个字节,四个字段组成: 源端口、目的端口、长度（UDP用户数据报长度）、检验和（检测UDP用户数据报传输过程中是否有错）

  + 伪首部： 计算检验和时临时添加在数据报前面，用来得到临时数据报的12个字节

  + 检验和计算算法： 临时数据报检验和字段设为0，若临时数据报不是偶数个字节，则在末尾补零，求16位和取反码得到检验和。

## TCP 传输控制

+ 主要特点：

1. 面向连接： 应用程序在使用TCP协议之前必须先建立TCP连接

2. 点对点通信： 每条TCP连接只能有两个端点

3. 可靠交付： 通过TCP连接传送的数据，无差错、不丢失、不重复，并且按序到达

4. 双全工通信： 双方的应用进程在任何时候都能发送数据。TCP连接的两端都设有发送缓存和接收缓存，用来临时存放双向通信的工具，TCP在合适的时候发送缓存里的数据，上层应用在合适的时候读取缓存里的数据

5. 面向字节流： TCP中的流指流入进程或从进程流出的字节序列。<br/>
TCP把应用程序交下来的`数据块`看成是一连串的`无结构的字节流`。TCP不知道所传送的字节流的含义，不保证接收方应用程序所收到的数据块和发送方的数据块具有对应大小关系。但发出跟收到的字节流完全一样。<br/><br/>

TCP根据对方给出的窗口值和当前网络的拥塞程度来决定一个报文段应包含多少个字节（UCP报文长度由应用进程给出）。可以划短一些或积累长一些再构成报文段发送。

### TCP连接

+ TCP连接有两个端点，该端点叫`套接字（socket）`或`插口`，端口号拼接到IP地址就构成`套接字`：<br/>

    套接字socket = （IP地址：端口号）

+ 每一条TCP连接唯一的被通信两端的两个端点所确定：

    TCP连接 ::= {socket1, socket2} = {(IP1:PORT1), (IP2:port2)}

### 可靠传输工作原理

1. 停止等待协议： 每发送完一个分组就停止发送，等待对方的确认

+ 为了提高传输效率，发送方可以使用流水线传输，连续发送多个分组，不必每发完一个就停顿等待确认

2. 自动重传请求ARQ： 重传请求是自动进行的，接收方不需要请求发送方重传某个出错的分组

3. 连续ARQ协议： 

发送方每收到一个确认，就把发送窗口向前滑动一个分组的位置。<br/>
接收方采用`累积确认`的方式，接收方在收到几个分组后对按序到达的最后一个分组发送确认,表示收到这个分组为止的所有分组

    + 累计确认的优点： 容易实现，确认丢失也不必重传<br/>
    + 累计确认的缺点： 不能向发送方反映出接收方已经正确收到的所有分组信息


### TCP报文段首部格式

1. 源端口和目的端口: 各占两个字节
2. 序号: 占4个字节(0~2^32-1).TCP中传输的每一个字节都按顺序编号,该字段填报文段所发送数据的第一个字节的序号
3. 确认号: 占4个字节.期望收到对方下一个报文段的第一个数据字节的序号
4. 数据偏移: 占4位.表示TCP报文首部的长度
5. 保留: 占6位.默认为0
6. 窗口: 占2字节(0～2^16-1).窗口字段指出允许对方发送的数据量。这个数值经常变动

以下为6个控制位

---
7. 紧急 URG

    当URG=1时，表明此报文段中有紧急数据，系统会优先传送。

8. 确认 ACK

    ACK=1时确认字段有效，等于0时无效（TCP规定所有传送的报文段都必须把ACK置1）。

9. 推送 PSH

    当接收方收到PSH设为1的报文段，会尽快的交付接收应用程序且立即响应，而不等缓存填满。

10. 复位 RST

    RST为1时，表明TCP连接中出现严重差错，必须释放当前连接并重新建立。

11. 同步 SYN

    在连接建立时用来同步序号。<br/>
    SYN=1，ACK=0时是连接请求报文段，<br/>
    SYN=1，ACK=1时是同意连接的响应报文段。

12. 终止 FIN

    用来释放一个连接。<br/>
    FIN=1时表明此报文段的发送方已发送完毕，要求释放连接。
---

13. 检验和： 占2字节，跟UDP计算过程一样

14. 紧急指针： 占2字节。

15. 选项： 最长可达40字节的可变字段

### 可靠传输工作原理

1. 停止等待协议

停止等待协议： 每发送完一个分组就停止发送，等待对方的确认。在收到确认后再发送下一个分组<br/>
全双工通信的双方即是发送方也是接收方。

+ 无差错情况：

A 发送分组 M1，发完就暂停发送，等待 B 的确认 (ACK)。B 收到了 M1 后向A发送 ACK。A 在收到了对 M1 的确认后，就再发送下一个分组  M2。

+ 出现差错：

    + 可能的情况： 

        1. B 接收 M1 时检测出了差错，就丢弃 M1，其他什么也不做（不通知 A 收到有差错的分组）。
        2. M1 在传输过程中丢失了，这时 B 当然什么都不知道，也什么都不做。
    
    + 解决方法： `超时重传`

        A 为每一个已发送的分组都设置了一个超时计时器。<br/>
        A 只要在超时计时器到期之前收到了相应的确认，就撤销该超时计时器，继续发送下一个分组 M2 。

+ 确认丢失和确认迟到：

    1. 确认丢失导致收到重传的分组：
        
        1） 丢弃重复的分组

        2） 发送确认

    2. 确认迟到导致收到重复分组：

        1） 丢弃重复分组

        2） 发送确认

        3） 确认接收方会收到重复确认，直接丢弃

2. 连续ARQ协议

+ 发送方维持一个`发送窗口`，位于发送窗口内的分组都可连续发送出去而不需要等待对方的确认，提高信道利用率。发送方每收到一个确认，就把发送窗口向前滑动该确认分组的位置

+ 接收方采用累积确认的方式，不必对收到的分组逐个发送确认，而是对按序到达的最后一个分组发送确认，表示到目前为止的所有分组都已正确收到了。

+ Go-Back-N： 如果发送了5个分组，中间的第三个分组丢失了，需要重传后面三个分组。

### TCP可靠传输实现

1. 以字节为单位的滑动窗口

+ TCP的滑动窗口以字节为单位.<br/>

+ A收到B发来的确认报文段： 窗口20字节，确认号31<br/>
表明B期望收到的下一个序号是31，A的发送窗口应为31~50

+ 发送缓存： 发送方的应用进程把字节流（已经送出但未收到确认和准备发送的数据，通常比发送窗口大）写入TCP的发送缓存

+ 接收缓存： 接收方的应用进程从TCP的接收缓存中读取字节流。（按序到达的但未被应用程序读取的数据、未按序到达的数据）

+ 强调三点：

    1） A的发送窗口不总是和B的接收窗口一样大（时间滞后）

    2） TCP标准未规定对不按序到达的数据应如何处理。通常先临时存放在接收窗口中，等字节流中缺少的字节收到后，再交付上层应用程序

    3） TCP要求接收方必须有累积确认的功能，这样可以减少传输开销

2. 超时重传的时间选择

+ 超时重传时间太短： 引起很多报文段的不必要重传，使网络负荷增大

+ 超时重传时间过长： 网络的空闲时间增大，减低传输效率

+ TCP采用自适应算法，记录一个报文的发出时间和相应的确认时间，这两个时间的时间差就是报文段的往返时间RTT。进行加权平均得到加权平均往返时间RTTs：

        新的RTTs = （1-a）×旧的RTTs×新的RTT

3. 选择确认SACK

确认选择SACK用于只传送缺少的数据而不重传已经正确到达接收方的数据。<br/>
大多数实现还是重传所有未被确认的数据块。

### TCP流量控制

1. 利用滑动窗口实现流量控制

+ 流量控制： 让发送方的发送速率不要太快，使得接收方来得及接收。

+ A 向 B 发送数据。在连接建立时，B 告诉 A：
“我的接收窗口 rwnd = 400（字节）”。<br/>
发送方的发送窗口不能超过接收方给出的接收窗口的数值。

+ TCP为每一个连接设有一个`持续计时器`。只要TCP连接的一方收到对方的零窗口通知，就启动持续计时器，计时器设置的时间到期，就发送一个零窗口的`探测报文段`（1字节），对方就在确认这个探测报文段时给出现在的窗口值。<br/>
若仍为0，则重设持续计时器。<br/>
若不为0，那么打破僵局。

2. TCP的传输效率

+ 控制TCP报文发送时机的三种机制：

    1) TCP维持一个变量，它等于最大报文段长度MSS。只要缓存中存放数据达到MSS字节时就组装成一个TCP报文段发送出去

    2) 发送方应用进程指明要求发送报文段

    3) 发送方计时器时限到了，把当前已有缓存装入报文段（不超过MSS）发送

+ 发送方糊涂综合征：

    + 发送方TCP每次接收到一字节数据后就发送出去

    解决： Nagle算法<br/>
    发送方就把第一个数据字节先发送出去，把后面到达的数据字节都缓存起来。当发送方收到对第一个数据字符的确认后，再把发送缓存中的所有数据组装成一个报文段发送出去，同时继续对随后到达的数据进行缓存。

+ 接收方糊涂综合征：

    + 接收方的 TCP 缓冲区已满。接收方的应用进程以交互方式每次只读取一个字节，于是接收方又发送窗口大小为一个字节的更新报文，发送方应邀发送一个字节的数据。

    解决： 让接收方等待一段时间，使得或者接收缓存已有足够空间容纳一个最长的报文段，或者等到接收缓存已有一半空闲的空间。只要出现这两种情况之一，接收方就发出确认报文，并向发送方通知当前的窗口大小。

### TCP拥塞控制

1. 拥塞控制一般原理

2. 拥塞控制方法

### TCP的运输连接管理

1. TCP连接建立

2. TCP连接释放

3. TCP的有限状态机